version: "3.7"

services:
  reverse_proxy:
    restart: unless-stopped
    image: bitnami/nginx:latest
    ports:
      - 80:80/tcp
      - 443:443/tcp
    environment:
      CERTBOT_EMAIL: shanur.cse.nitap@gmail.com
      # variable names are space-separated
      ENVSUBST_VARS: FQDN
      FQDN: moleculesystem.com
    volumes:
      - ./conf.d/nginx.conf:/opt/bitnami/nginx/conf/server_blocks/my_server_block.conf:ro
      # - letsencrypt:/etc/letsencrypt
      # - /home/ec2-user/leon:/usr/share/nginx/html
    depends_on:
      - main
    networks:
      - webnet
  main:
    image: "node:14-slim"
    container_name: main
    depends_on:
      # - "mongodb"
      - "redis"
    build:
      context: .
      dockerfile: Dockerfile.prod
      # target: development
    user: "root"
    working_dir: /usr/src/app
    environment:
      # - NODE_ENV=production
      - VERSION=1.0
    volumes:
      - /usr/src/app
      - /usr/app/node_modules
    ports:
      - "3000:3000"
      - "9229:9229"
    tty: true
    command: "node dist/main.js"
    env_file:
      - env/production.env
    networks:
      - webnet
    restart: always

  # metabase-app:
  #   image: metabase/metabase
  #   restart: always
  #   ports:
  #     - 3001:3000
  #   volumes:
  #     # declare your mount volume /host/dir:/container/dir
  #     - /home/app/metabase-data:/metabase-data
  #   # env_file:
  #   #   - .env
  #   environment:
  #     MB_DB_TYPE: postgres
  #     MB_DB_DBNAME: aotocyla
  #     MB_DB_PORT: 5432
  #     MB_DB_USER: aotocyla
  #     MB_DB_PASS: 8zLQ1t3VdTluHgfzsLmtu4Aq5K0vgYvK
  #     MB_DB_HOST: john.db.elephantsql.com

  # portainerservice:
  #   image: portainer/portainer
  #   volumes:
  #     - portainer_data:/data
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   ports:
  #     - "9000:9000"

  # mongodb:
  #   container_name: mongoback # take snapshot:: `docker exec mongoback sh -c 'mongodump --archive' > db.dump`
  #   image: "docker.io/bitnami/mongodb:4.4-debian-10"
  #   ports:
  #     - "27017:27017"
  #   volumes:
  #     - "mongodb_data:/bitnami/mongodb"
  #   networks:
  #     - webnet

  # this will run on a separate instance in production later
  worker:
    image: "node:14.15.1-alpine3.12"
    container_name: worker
    build:
      context: .
      dockerfile: Dockerfile.prod
      # target: production
    user: "node"
    working_dir: /usr/src/app
    environment:
      - NODE_ENV=production
      - VERSION=1.0
    # volumes are only required for live reloading and binding local directories
    # volumes:
    #   - /usr/src/app
    #   - /usr/app/node_modules
    # ports:
    #   - "3000:3000"
    tty: true
    command: "yarn start:prod"
    env_file:
      - ../molecule_bull_microservice/.env
    networks:
      - webnet
    restart: always

  redis:
    image: "bitnami/redis:latest"
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - REDIS_PASSWORD=password123
      - REDIS_USER=shanur
    command: /opt/bitnami/scripts/redis/run.sh --maxmemory 100mb
    ports:
      - "6379:6379"
    networks:
      - webnet

  minio:
    image: docker.io/bitnami/minio:2022
    container_name: minio
    ports:
      # - "9009:9000"
      - "9001:9001"
    volumes:
      - 'minio_data:/data'
    environment:
      - MINIO_ACCESS_KEY=AKIARGBOXP35BONONB4J
      - MINIO_SECRET_KEY=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
    networks:
      - webnet

networks:
  webnet:
volumes:
  portainer_data:
  pgdata:
  mongodb_data:
    driver: local
  minio_data:
    driver: local
