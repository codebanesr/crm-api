version: "3.7"

services:
  reverse_proxy:
    restart: unless-stopped
    image: bitnami/nginx:latest
    ports:
      - 80:80/tcp
      - 443:443/tcp
    volumes:
      - ./conf.d/nginx.conf:/opt/bitnami/nginx/conf/server_blocks/my_server_block.conf:ro
    depends_on:
      - main
    networks:
      - webnet
  main:
    image: "shanurcsenitap/crm"
    container_name: main
    depends_on:
      # - "mongodb"
      - "redis"
    build:
      context: .
      dockerfile: Dockerfile.prod
      # target: development
    user: "root"
    working_dir: /usr/src/app
    environment:
      # - NODE_ENV=production
      - VERSION=1.0
    volumes:
      - /usr/src/app
      - /usr/app/node_modules
    ports:
      - "3000:3000"
      - "9229:9229"
    tty: true
    command: "node dist/main.js"
    env_file:
      - env/production.env
    networks:
      - webnet
    restart: always

  # metabase-app:
  #   image: metabase/metabase
  #   restart: always
  #   ports:
  #     - 3001:3000
  #   volumes:
  #     # declare your mount volume /host/dir:/container/dir
  #     - /home/app/metabase-data:/metabase-data
  #   # env_file:
  #   #   - .env
  #   environment:
  #     MB_DB_TYPE: postgres
  #     MB_DB_DBNAME: aotocyla
  #     MB_DB_PORT: 5432
  #     MB_DB_USER: aotocyla
  #     MB_DB_PASS: 8zLQ1t3VdTluHgfzsLmtu4Aq5K0vgYvK
  #     MB_DB_HOST: john.db.elephantsql.com

  # mongodb:
  #   container_name: mongoback # take snapshot:: `docker exec mongoback sh -c 'mongodump --archive' > db.dump`
  #   image: "docker.io/bitnami/mongodb:4.4-debian-10"
  #   ports:
  #     - "27017:27017"
  #   volumes:
  #     - "mongodb_data:/bitnami/mongodb"
  #   networks:
  #     - webnet

  # this will run on a separate instance in production later
  worker:
    image: "shanurcsenitap/worker"
    container_name: worker
    build:
      context: "../molecule_bull_microservice"
      dockerfile: Dockerfile.prod
      # target: production
    user: "root"
    working_dir: /usr/src/app
    environment:
      - NODE_ENV=production
      - VERSION=1.0
    # volumes are only required for live reloading and binding local directories
    # volumes:
    #   - /usr/src/app
    #   - /usr/app/node_modules
    # ports:
    #   - "3000:3000"
    tty: true
    command: "node dist/main.js"
    env_file:
      - ../molecule_bull_microservice/.env
    networks:
      - webnet
    restart: always

  redis:
    image: "bitnami/redis:latest"
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - REDIS_PASSWORD=password123
      - REDIS_USER=shanur
    command: /opt/bitnami/scripts/redis/run.sh --maxmemory 100mb
    ports:
      - "6379:6379"
    networks:
      - webnet

networks:
  webnet:
# volumes:
#   portainer_data:
#   pgdata:
#   mongodb_data:
#     driver: local